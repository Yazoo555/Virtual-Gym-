using UnityEngine;
using StarterAssets;

public class CarNavigatorScript : MonoBehaviour
{
    [Header("Car Settings")]
    public float baseMovingSpeed = 10f;
    public float turningSpeed = 300f;
    public float stopDistance = 1f;

    [Header("Destination Settings")]
    public Vector3 destination;
    public bool destinationReached;
    private float currentMovingSpeed;

    [Header("Player Detection")]
    public GameObject sensor; // Assign an empty GameObject at car's front
    public float detectionRange = 10f;
    public float brakeDistance = 5f; // Distance to start slowing down
    [SerializeField] private GameObject detectedPlayer;
    [SerializeField] private bool playerDetected;

    private void Start()
    {
        currentMovingSpeed = baseMovingSpeed;

        // Warn if sensor isn't assigned
        if (sensor == null)
        {
            Debug.LogWarning("Sensor not assigned to CarNavigatorScript. Player detection won't work.");
        }
    }

    private void Update()
    {
        DetectPlayer();
        HandlePlayerDetection();
        Drive();
        CheckDestinationReached();
    }

    void DetectPlayer()
    {
        playerDetected = false;
        detectedPlayer = null;

        if (sensor == null) return;

        // Cast a wider sphere check first
        Collider[] hits = Physics.OverlapSphere(sensor.transform.position, 2f);
        foreach (Collider col in hits)
        {
            if (col.CompareTag("Player") || col.GetComponent<ThirdPersonController>() != null)
            {
                detectedPlayer = col.gameObject;
                playerDetected = true;
                return;
            }
        }

        // Fall back to raycast
        RaycastHit hitInfo;
        if (Physics.Raycast(sensor.transform.position, sensor.transform.forward, out hitInfo, detectionRange))
        {
            if (hitInfo.transform.CompareTag("Player") ||
                hitInfo.transform.GetComponent<ThirdPersonController>() != null)
            {
                detectedPlayer = hitInfo.transform.gameObject;
                playerDetected = true;
            }
        }
    }

    void HandlePlayerDetection()
    {
        if (!playerDetected || detectedPlayer == null)
        {
            currentMovingSpeed = Mathf.Lerp(currentMovingSpeed, baseMovingSpeed, Time.deltaTime * 5f);
            return;
        }

        float distance = Vector3.Distance(sensor.transform.position, detectedPlayer.transform.position);

        if (distance <= brakeDistance)
        {
            float speedFactor = Mathf.Clamp01(distance / brakeDistance);
            currentMovingSpeed = Mathf.Lerp(0, baseMovingSpeed * 0.3f, speedFactor);

            if (distance < stopDistance * 1.5f)
            {
                currentMovingSpeed = 0;
            }
        }
    }

    void CheckDestinationReached()
    {
        if (Vector3.Distance(transform.position, destination) <= stopDistance)
        {
            destinationReached = true;
        }
    }

    public void Drive()
    {
        if (transform.position != destination && !destinationReached)
        {
            Vector3 destinationDirection = destination - transform.position;
            destinationDirection.y = 0;

            Quaternion targetRotation = Quaternion.LookRotation(destinationDirection);
            transform.rotation = Quaternion.RotateTowards(
                transform.rotation,
                targetRotation,
                turningSpeed * Time.deltaTime
            );

            transform.Translate(Vector3.forward * currentMovingSpeed * Time.deltaTime);
        }
    }

    // Visualize detection range in editor
    private void OnDrawGizmosSelected()
    {
        if (sensor != null)
        {
            Gizmos.color = new Color(1f, 0f, 1f); // Magenta (R = 1, G = 0, B = 1)
            Gizmos.DrawLine(sensor.transform.position, sensor.transform.position + sensor.transform.forward * detectionRange);

            if (playerDetected)
            {
                Gizmos.color = Color.yellow;
                Gizmos.DrawSphere(sensor.transform.position + sensor.transform.forward * detectionRange, 0.5f);
            }
        }
    }
}